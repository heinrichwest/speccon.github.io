<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learnership Application</title>
  <style>
    :root { --bg:#f7f7fb; --fg:#111; --muted:#666; --brand:#0a6; --error:#c00; --ok:#0a6; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0}
    .container{max-width:980px;margin:2rem auto;padding:2rem;background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
    h1{margin:0 0 1rem}
    fieldset{border:1px solid #e6e6ef;padding:1.25rem;border-radius:12px;margin:1rem 0}
    legend{padding:0 .5rem;font-weight:700}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
    label{display:block;font-weight:600;margin:.25rem 0}
    input[type=text],input[type=email],input[type=tel],input[type=date],select,textarea{width:100%;padding:.75rem;border:1px solid #d8dae5;border-radius:10px;font:inherit}
    small{color:var(--muted)}
    .radios{display:flex;flex-wrap:wrap;gap:12px}
    .radios label{font-weight:500}
    .hidden{display:none!important}
    .help{font-size:.9rem;color:var(--muted)}
    .pill{display:inline-block;padding:.25rem .5rem;border:1px solid #e6e6ef;border-radius:9999px;color:#444;background:#fafafa;margin-left:.5rem}
    .error{color:var(--error);font-weight:600}
    .success{color:var(--ok);font-weight:600}
    button{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:.9rem 1.2rem;font-weight:700;cursor:pointer}
    .note{background:#f0fdf6;border:1px solid #c6f6d5;color:#065f46;border-radius:12px;padding:.75rem 1rem;margin:.75rem 0}
  </style>
</head>
<body>
  <main class="container">
    <h1>Learnership Application</h1>
    <p class="help">Fields marked with * are required. Your application may be automatically declined based on eligibility rules.</p>

    <form id="learnershipForm" method="post" action="/learnerships/save_application.php" novalidate>
      <!-- Hidden fields populated by JS before submit -->
      <input type="hidden" name="preliminary_status" id="preliminary_status" value="Applied" />
      <input type="hidden" name="decline_reasons" id="decline_reasons" value="" />
      <input type="hidden" name="birthdate" id="birthdate" value="" />
      <input type="hidden" name="age_at_application" id="age_at_application" value="" />

      <fieldset>
        <legend>Personal Details</legend>
        <div class="row">
          <div class="col-6">
            <label for="name">First Name *</label>
            <input id="name" name="name" type="text" required />
          </div>
          <div class="col-6">
            <label for="surname">Surname *</label>
            <input id="surname" name="surname" type="text" required />
          </div>
          <div class="col-6">
            <label for="id_number">South African ID Number *</label>
            <input id="id_number" name="id_number" type="text" inputmode="numeric" pattern="^\d{13}$" required />
            <small>13 digits. We use this to verify age eligibility.</small>
          </div>
          <div class="col-6">
            <label>Gender *</label>
            <div class="radios">
              <label><input type="radio" name="gender" value="Male" required> Male</label>
              <label><input type="radio" name="gender" value="Female" required> Female</label>
            </div>
          </div>
          <div class="col-6">
            <label>Race *</label>
            <div class="radios">
              <label><input type="radio" name="race" value="African" required> African</label>
              <label><input type="radio" name="race" value="Coloured" required> Coloured</label>
              <label><input type="radio" name="race" value="Indian" required> Indian</label>
              <label><input type="radio" name="race" value="White" required> White</label>
            </div>
          </div>
          <div class="col-6">
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" required />
          </div>
          <div class="col-6">
            <label for="contact_no1">Contact Number *</label>
            <input id="contact_no1" name="contact_no1" type="tel" inputmode="tel" pattern="^\d{10}$" required />
            <small>10 digits</small>
          </div>
          <div class="col-6">
            <label for="contact_no2">Additional Contact Number</label>
            <input id="contact_no2" name="contact_no2" type="tel" inputmode="tel" pattern="^\d{10}$" />
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Address</legend>
        <div class="row">
          <div class="col-12">
            <label for="address_street">Street Name & Number *</label>
            <input id="address_street" name="address_street" type="text" required />
          </div>
          <div class="col-6">
            <label for="address_suburb">Suburb *</label>
            <input id="address_suburb" name="address_suburb" type="text" required />
          </div>
          <div class="col-6">
            <label for="address_city">Town/City *</label>
            <input id="address_city" name="address_city" type="text" required />
          </div>
          <div class="col-6">
            <label for="address_province">Province *</label>
            <select id="address_province" name="address_province" required>
              <option value="">Select…</option>
              <option>Eastern Cape</option>
              <option>Free State</option>
              <option>Gauteng</option>
              <option>Kwazulu-Natal</option>
              <option>Limpopo</option>
              <option>Mpumalanga</option>
              <option>Northern Cape</option>
              <option>North-West</option>
              <option>Western Cape</option>
            </select>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Eligibility</legend>
        <div class="row">
          <div class="col-6">
            <label>Do you have a criminal record? *</label>
            <div class="radios">
              <label><input type="radio" name="criminal_record" value="Yes" required> Yes</label>
              <label><input type="radio" name="criminal_record" value="No" required> No</label>
            </div>
          </div>
          <div class="col-6">
            <label>Highest Qualification *</label>
            <select name="highest_qualification" id="highest_qualification" required>
              <option value="">Select…</option>
              <option>Grade 10</option>
              <option>Grade 11</option>
              <option>Grade 12 (Matric)</option>
              <option>National Certificate (NQF 5)</option>
              <option>Diploma</option>
              <option>Bachelor’s</option>
            </select>
          </div>
          <div class="col-6">
            <label>Employment Status *</label>
            <div class="radios">
              <label><input type="radio" name="employment_status" value="Employed" required> Employed</label>
              <label><input type="radio" name="employment_status" value="Unemployed" required> Unemployed</label>
            </div>
          </div>
          <div class="col-6">
            <label>Learnership Status *</label>
            <div class="radios">
              <label><input type="radio" name="learnership_status" value="Never" required> I have never been on a learnership</label>
              <label><input type="radio" name="learnership_status" value="Current" required> I am currently on a learnership</label>
              <label><input type="radio" name="learnership_status" value="Completed" required> I have been on a learnership and have completed it</label>
            </div>
          </div>
          <div id="previousLearnershipBlock" class="col-12 hidden">
            <div class="row">
              <div class="col-6">
                <label for="previous_learnership">Name of Learnership *</label>
                <input id="previous_learnership" name="previous_learnership" type="text" />
              </div>
              <div class="col-3">
                <label for="previous_learnership_completion_date">Date of completion *</label>
                <input id="previous_learnership_completion_date" name="previous_learnership_completion_date" type="date" />
              </div>
              <div class="col-3">
                <label>Was a certificate issued? *</label>
                <div class="radios">
                  <label><input type="radio" name="certificate_issued" value="Yes"> Yes</label>
                  <label><input type="radio" name="certificate_issued" value="No"> No</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Work Readiness</legend>
        <div class="row">
          <div class="col-6">
            <label>Are you able to work from home? *</label>
            <div class="radios">
              <label><input type="radio" name="able_to_work_from_home" value="Yes" required> Yes</label>
              <label><input type="radio" name="able_to_work_from_home" value="No" required> No</label>
            </div>
          </div>
          <div class="col-6">
            <label>Do you have access to a computer/smart phone and internet? *</label>
            <div class="radios">
              <label><input type="radio" name="online_access" value="Yes" required> Yes</label>
              <label><input type="radio" name="online_access" value="No" required> No</label>
            </div>
          </div>
          <div class="col-12">
            <label>Which of the following best describes your current skills? *</label>
            <select id="current_skills" name="current_skills" required>
              <option value="">Select…</option>
              <option>Website development / design</option>
              <option>IT Systems Development</option>
              <option>Marketing</option>
              <option>Sales / Retail</option>
              <option>Graphical Design</option>
              <option>Administration</option>
              <option>Stores / Warehousing</option>
              <option>Finance</option>
              <option>Farming</option>
              <option>Contact Centre</option>
              <option>General</option>
            </select>
            <small>We’ll send you an assessment that matches your selection.</small>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Ability & Location</legend>
        <div class="row">
          <div class="col-6">
            <label>What is your current status? *</label>
            <div class="radios">
              <label><input type="radio" name="ability" value="Abled" required> Abled</label>
              <label><input type="radio" name="ability" value="Disabled" required> Disabled (Certified by Medical Practitioner)</label>
            </div>
          </div>

          <div id="abledAreas" class="col-6 hidden">
            <label>Which learnership area are you interested in? *</label>
            <select id="applied_for_abled" name="applied_for_abled">
              <option value="">Select…</option>
              <option>Centurion – Abled</option>
              <option>Bellville – Abled</option>
              <option>Mbombella – Abled</option>
              <option>Pinetown – Abled</option>
            </select>
            <small class="help">Admins can add more areas later.</small>
          </div>

          <div id="disabilityBlock" class="col-12 hidden">
            <div class="row">
              <div class="col-6">
                <label>What is the nature of your disability? *</label>
                <select id="disability_type" name="disability_type">
                  <option value="">Select…</option>
                  <option>Communication (talking / listening)</option>
                  <option>Sight (even with glasses)</option>
                  <option>Hearing (even with a hearing aid)</option>
                  <option>Physical (moving/standing/grasping)</option>
                  <option>Emotional (behavioural/psychological)</option>
                  <option>Intellectual (learning difficulty)</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="col-6">
                <label for="special_requirements">Do you have any access requirement to support your disability? *</label>
                <textarea id="special_requirements" name="special_requirements" rows="3"></textarea>
              </div>
              <div class="col-6">
                <label>Which learnership area are you interested in? *</label>
                <select id="applied_for_disabled" name="applied_for_disabled">
                  <option value="">Select…</option>
                  <option>Centurion – Disabled</option>
                  <option>Bellville – Disabled</option>
                  <option>Mbombella – Disabled</option>
                  <option>Pinetown – Disabled</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Motivation & Readiness Check</legend>
        <p class="help">Answer all correctly to proceed.</p>
        <div class="row">
          <div class="col-12">
            <label>Why are you applying for this learnership? *</label>
            <div class="radios">
              <label><input type="radio" name="q28" value="wrong" required> It offers a stipend and I need money.</label>
              <label><input type="radio" name="q28" value="correct" required> I want to gain experience that will help me find a job.</label>
              <label><input type="radio" name="q28" value="wrong" required> My family told me to apply.</label>
              <label><input type="radio" name="q28" value="wrong" required> I am bored at home.</label>
            </div>
          </div>
          <div class="col-12">
            <label>What do you expect to have by completing this learnership? *</label>
            <div class="radios">
              <label><input type="radio" name="q29" value="wrong" required> Enough stipends to support myself for a year</label>
              <label><input type="radio" name="q29" value="wrong" required> A certificate to keep for later</label>
              <label><input type="radio" name="q29" value="correct" required> Practical experience and proof of my work skills</label>
              <label><input type="radio" name="q29" value="wrong" required> Time to figure out what I want to do</label>
            </div>
          </div>
          <div class="col-12">
            <label>What would you do if you didn’t get paid for a month due to admin delays? *</label>
            <div class="radios">
              <label><input type="radio" name="q30" value="wrong" required> Quit – I can’t work without being paid</label>
              <label><input type="radio" name="q30" value="correct" required> Continue learning and working while resolving the issue professionally</label>
              <label><input type="radio" name="q30" value="wrong" required> Do the minimum until payment is made</label>
              <label><input type="radio" name="q30" value="wrong" required> Stop working and look for another learnership elsewhere</label>
            </div>
          </div>
          <div class="col-12">
            <label>How will you use this learnership to find employment? *</label>
            <div class="radios">
              <label><input type="radio" name="q31" value="correct" required> I’ll use the experience and references to apply for a job</label>
              <label><input type="radio" name="q31" value="wrong" required> I’ll try to join another learnership</label>
              <label><input type="radio" name="q31" value="wrong" required> I haven’t really thought about it</label>
              <label><input type="radio" name="q31" value="wrong" required> I expect the company to offer me a job automatically</label>
            </div>
          </div>
          <div class="col-12">
            <label>If you are offered another learnership with a bigger stipend but no practical work, what would you do? *</label>
            <div class="radios">
              <label><input type="radio" name="q32" value="wrong" required> Take the one with more money</label>
              <label><input type="radio" name="q32" value="wrong" required> Try to do both at the same time</label>
              <label><input type="radio" name="q32" value="correct" required> Stay with the one that give me work experience</label>
              <label><input type="radio" name="q32" value="wrong" required> Leave it for my family to decide for me</label>
            </div>
          </div>
          <div class="col-12">
            <label>If you are currently on a learnership, will your current company allow you to register for another learnership? *</label>
            <div class="radios">
              <label><input type="radio" name="q33" value="wrong" required> No, they will not allow me</label>
              <label><input type="radio" name="q33" value="wrong" required> I haven’t completed, but I’m not attending anymore</label>
              <label><input type="radio" name="q33" value="wrong" required> Yes, they will not have a problem</label>
              <label><input type="radio" name="q33" value="correct" required> I am not registered on another learnership</label>
            </div>
          </div>
        </div>
      </fieldset>

      <p id="statusMsg" class="note hidden"></p>

      <button type="submit">Submit Application</button>
    </form>
  </main>

  <script>
    // === Utility: SA ID validation (length/date + Luhn) ===
    function luhnCheck(id) {
      let sum = 0, alt = false;
      for (let i = id.length - 1; i >= 0; i--) {
        let n = parseInt(id.charAt(i), 10);
        if (alt) { n *= 2; if (n > 9) n -= 9; }
        sum += n; alt = !alt;
      }
      return sum % 10 === 0;
    }
    function parseDOBFromID(id) {
      const yy = parseInt(id.substring(0,2),10);
      const mm = parseInt(id.substring(2,4),10);
      const dd = parseInt(id.substring(4,6),10);
      const now = new Date();
      const currentYY = now.getFullYear() % 100;
      const century = yy > currentYY ? 1900 : 2000;
      const year = century + yy;
      const dob = new Date(year, mm-1, dd);
      // basic validity check
      if (dob.getFullYear() !== year || (dob.getMonth()+1) !== mm || dob.getDate() !== dd) return null;
      return dob;
    }
    function ageOn(date, dob) {
      let a = date.getFullYear() - dob.getFullYear();
      const m = date.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && date.getDate() < dob.getDate())) a--;
      return a;
    }

    // Skills → assessment link placeholder (replace with real links)
    const ASSESSMENT_LINKS = {
      "Website development / design": https://example.com/assess/web,
      "IT Systems Development": https://example.com/assess/it,
      "Marketing": https://example.com/assess/mkt,
      "Sales / Retail": https://example.com/assess/sales,
      "Graphical Design": https://example.com/assess/design,
      "Administration": https://example.com/assess/admin,
      "Stores / Warehousing": https://example.com/assess/stores,
      "Finance": https://example.com/assess/finance,
      "Farming": https://example.com/assess/farming,
      "Contact Centre": https://example.com/assess/contact,
      "General": https://example.com/assess/general
    };

    const form = document.getElementById('learnershipForm');
    const statusMsg = document.getElementById('statusMsg');

    function show(el){el.classList.remove('hidden')}
    function hide(el){el.classList.add('hidden')}

    const learnershipRadios = form.querySelectorAll('input[name="learnership_status"]');
    const prevBlock = document.getElementById('previousLearnershipBlock');
    learnershipRadios.forEach(r => r.addEventListener('change', () => {
      if (r.checked && r.value === 'Completed') {
        show(prevBlock);
        // mark required when shown
        form.previous_learnership.required = true;
        form.previous_learnership_completion_date.required = true;
        [...form.querySelectorAll('input[name="certificate_issued"]')].forEach(inp => inp.required = true);
      } else if (r.checked) {
        hide(prevBlock);
        form.previous_learnership.required = false;
        form.previous_learnership_completion_date.required = false;
        [...form.querySelectorAll('input[name="certificate_issued"]')].forEach(inp => inp.required = false);
      }
    }));

    const abilityRadios = form.querySelectorAll('input[name="ability"]');
    const abledAreas = document.getElementById('abledAreas');
    const disabilityBlock = document.getElementById('disabilityBlock');
    abilityRadios.forEach(r => r.addEventListener('change', () => {
      if (r.checked && r.value === 'Abled') {
        show(abledAreas); hide(disabilityBlock);
        form.applied_for_abled.required = true;
        form.applied_for_disabled.required = false;
        if (form.disability_type) form.disability_type.required = false;
        if (form.special_requirements) form.special_requirements.required = false;
      } else if (r.checked) {
        hide(abledAreas); show(disabilityBlock);
        form.applied_for_abled.required = false;
        form.applied_for_disabled.required = true;
        if (form.disability_type) form.disability_type.required = true;
        if (form.special_requirements) form.special_requirements.required = true;
      }
    }));

    function computeEligibility() {
      const reasons = [];
      const id = form.id_number.value.trim();
      if (!/^\d{13}$/.test(id) || !luhnCheck(id)) reasons.push('ID number is invalid.');
      const dob = parseDOBFromID(id);
      if (!dob) reasons.push('Birthdate in ID is invalid.');
      else {
        const now = new Date();
        const in12m = new Date(now.getFullYear(), now.getMonth()+12, now.getDate());
        const thirtieth = new Date(dob.getFullYear()+30, dob.getMonth(), dob.getDate());
        if (thirtieth <= in12m) reasons.push('Age 30 or older within the next 12 months.');
        // fill hidden fields
        document.getElementById('birthdate').value = dob.toISOString().slice(0,10);
        document.getElementById('age_at_application').value = ageOn(now, dob);
      }
      const crim = form.querySelector('input[name="criminal_record"]:checked');
      if (crim && crim.value === 'Yes') reasons.push('Criminal record.');
      const ls = form.querySelector('input[name="learnership_status"]:checked');
      if (ls && ls.value === 'Current') reasons.push('Currently on a learnership.');
      // Quiz 28-33 must all be correct
      ['q28','q29','q30','q31','q32','q33'].forEach(q => {
        const a = form.querySelector(`input[name="${q}"]:checked`);
        if (!a || a.value !== 'correct') reasons.push(`Question ${q.replace('q','')} answered incorrectly.`);
      });
      // applied_for value (depending on ability)
      let appliedFor = '';
      const ability = form.querySelector('input[name="ability"]:checked');
      if (ability && ability.value === 'Abled') appliedFor = form.applied_for_abled.value;
      if (ability && ability.value === 'Disabled') appliedFor = form.applied_for_disabled.value;
      // ensure area chosen
      if (!appliedFor) reasons.push('Learnership area not selected.');
      return reasons;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusMsg.classList.add('hidden');
      const reasons = computeEligibility();
      const prelim = reasons.length ? 'Declined' : 'Applied';
      document.getElementById('preliminary_status').value = prelim;
      document.getElementById('decline_reasons').value = reasons.join('; ');

      if (!form.reportValidity()) {
        statusMsg.textContent = 'Please fix the highlighted fields.';
        statusMsg.className = 'note error';
        statusMsg.classList.remove('hidden');
        return;
      }

      // Construct FormData and set derived applied_for
      const fd = new FormData(form);
      const ability = form.querySelector('input[name="ability"]:checked');
      let appliedFor = '';
      if (ability && ability.value === 'Abled') appliedFor = form.applied_for_abled.value;
      if (ability && ability.value === 'Disabled') appliedFor = form.applied_for_disabled.value;
      fd.append('applied_for', appliedFor);
      // include assessment link hint
      const skill = form.current_skills.value;
      fd.append('assessment_link_hint', ASSESSMENT_LINKS[skill] || '');

      // Submit to server
      try {
        const resp = await fetch(form.action, { method: 'POST', body: fd });
        const data = await resp.json();
        if (data.success) {
          statusMsg.innerHTML = `✅ Application submitted. <span class="pill">Status: ${data.application_status}</span> OTP: <strong>${data.otp}</strong>`;
          statusMsg.className = 'note success';
          statusMsg.classList.remove('hidden');
          form.reset();
          // Hide conditional blocks again
          hide(document.getElementById('previousLearnershipBlock'));
          hide(document.getElementById('abledAreas'));
          hide(document.getElementById('disabilityBlock'));
        } else {
          statusMsg.textContent = 'Submission failed: ' + (data.error || 'Unknown error');
          statusMsg.className = 'note error';
          statusMsg.classList.remove('hidden');
        }
      } catch (err) {
        statusMsg.textContent = 'Network or server error. Please try again.';
        statusMsg.className = 'note error';
        statusMsg.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
